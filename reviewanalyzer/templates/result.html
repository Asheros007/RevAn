{% extends 'base.html' %}
{% load static %}

{% block title %}Results | RevAn{% endblock %}

{% block content %}
<div class="results-header">
    <h1>Analysis Results</h1>
    <p>Detailed breakdown of review sentiment analysis</p>
</div>

<!-- Product Overview Card -->
<div class="card">
    <div class="card-header">
        <h2>üì¶ Product Overview</h2>
    </div>
    <div class="product-info">
        <div class="info-grid">
            <div class="info-item">
                <strong>Product:</strong>
                <span>{{ product_name }}</span>
            </div>
            <div class="info-item">
                <strong>Overall Sentiment:</strong>
                <span class="sentiment-{{ overview.sentiment }}">
                    {{ overview.sentiment|title }} (Score: {{ overview.score }})
                </span>
            </div>
            <div class="info-item">
                <strong>Review Length:</strong>
                <span>{{ metrics.total_words }} words</span>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats Cards -->
<div class="stats-grid">
    <div class="stat-card positive">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-content">
            <div class="stat-number">{{ metrics.word_counts.positive }}</div>
            <div class="stat-label">Positive Words</div>
            <div class="stat-percentage">{{ metrics.percentages.positive }}%</div>
        </div>
    </div>
    
    <div class="stat-card negative">
        <div class="stat-icon">‚ùå</div>
        <div class="stat-content">
            <div class="stat-number">{{ metrics.word_counts.negative }}</div>
            <div class="stat-label">Negative Words</div>
            <div class="stat-percentage">{{ metrics.percentages.negative }}%</div>
        </div>
    </div>
    
    <div class="stat-card neutral">
        <div class="stat-icon">‚ö™</div>
        <div class="stat-content">
            <div class="stat-number">{{ metrics.word_counts.neutral }}</div>
            <div class="stat-label">Neutral Words</div>
            <div class="stat-percentage">{{ metrics.percentages.neutral }}%</div>
        </div>
    </div>
    
    <div class="stat-card modifiers">
        <div class="stat-icon">üìä</div>
        <div class="stat-content">
            <div class="stat-number">{{ metrics.word_counts.intensifiers }}</div>
            <div class="stat-label">Intensifiers</div>
            <div class="stat-number">{{ metrics.word_counts.negations }}</div>
            <div class="stat-label">Negations</div>
        </div>
    </div>
</div>

<!-- Review Summary Card -->
<div class="card">
    <div class="card-header">
        <h2>üìù Review Summary</h2>
        <p>Key points extracted from the review</p>
    </div>
    
    <!-- Positive Summary -->
    {% if summary.positive %}
    <div class="summary-section positive">
        <h3 class="summary-title">‚úÖ Positive Aspects</h3>
        <div class="summary-content">
            {% for sentence in summary.positive %}
            <div class="summary-item">
                <span class="bullet">‚Ä¢</span>
                {{ sentence }}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Negative Summary -->
    {% if summary.negative %}
    <div class="summary-section negative">
        <h3 class="summary-title">‚ùå Areas for Improvement</h3>
        <div class="summary-content">
            {% for sentence in summary.negative %}
            <div class="summary-item">
                <span class="bullet">‚Ä¢</span>
                {{ sentence }}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Neutral Summary -->
    {% if summary.neutral %}
    <div class="summary-section neutral">
        <h3 class="summary-title">‚ö™ Additional Observations</h3>
        <div class="summary-content">
            {% for sentence in summary.neutral %}
            <div class="summary-item">
                <span class="bullet">‚Ä¢</span>
                {{ sentence }}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Detailed Word Analysis Card -->
<div class="card">
    <div class="card-header">
        <h2>üîç Detailed Word Analysis</h2>
        <p>Words that influenced the sentiment score</p>
    </div>
    
    <div class="word-analysis">
        <!-- Positive Words -->
        <div class="word-category">
            <h4>‚úÖ Positive Words ({{ word_analysis.positive_words|length }})</h4>
            <div class="word-list">
                {% for word in word_analysis.positive_words %}
                <span class="word-tag positive" 
                      title="Score: {{ word.contributed_score|floatformat:2 }}, Position: {{ word.position }}">
                    {{ word.word }} ({{ word.contributed_score|floatformat:2 }})
                </span>
                {% empty %}
                <p class="no-words">No positive words detected</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Negative Words -->
        <div class="word-category">
            <h4>‚ùå Negative Words ({{ word_analysis.negative_words|length }})</h4>
            <div class="word-list">
                {% for word in word_analysis.negative_words %}
                <span class="word-tag negative"
                      title="Score: {{ word.contributed_score|floatformat:2 }}, Position: {{ word.position }}">
                    {{ word.word }} ({{ word.contributed_score|floatformat:2 }})
                </span>
                {% empty %}
                <p class="no-words">No negative words detected</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Intensifiers -->
        <div class="word-category">
            <h4>‚ö° Intensifiers ({{ word_analysis.intensifiers|length }})</h4>
            <div class="word-list">
                {% for intensifier in word_analysis.intensifiers %}
                <span class="word-tag intensifier"
                      title="Position: {{ intensifier.position }}, Multiplier: {{ intensifier.multiplier }}">
                    {{ intensifier.word }} (√ó{{ intensifier.multiplier }})
                </span>
                {% empty %}
                <p class="no-words">No intensifiers detected</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Negations -->
        <div class="word-category">
            <h4>üö´ Negations ({{ word_analysis.negations|length }})</h4>
            <div class="word-list">
                {% for negation in word_analysis.negations %}
                <span class="word-tag negation"
                      title="Position: {{ negation.position }}, Active: {{ negation.active }}">
                    {{ negation.word }}
                </span>
                {% empty %}
                <p class="no-words">No negations detected</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Original Review Card -->
<div class="card">
    <div class="card-header">
        <h2>üìÑ Original Review</h2>
    </div>
    <div class="review-content">
        <p>{{ review_text|linebreaks }}</p>
    </div>
</div>

<!-- Action Buttons -->
<div class="action-buttons">
    <a href="{% url 'analyze' %}" class="btn primary">üéØ Analyze New Review</a>
    <a href="{% url 'history' %}" class="btn secondary">üìö View Analysis History</a>
    <a href="{% url 'dashboard' %}" class="btn secondary">üè† Back to Dashboard</a>
    
    <form method="POST" action="{% url 'save_analysis' %}" id="saveAnalysisForm" style="display: inline;">
        {% csrf_token %}
        
        <!-- Basic data -->
        <input type="hidden" name="product_name" value="{{ product_name }}">
        <input type="hidden" name="review_text" value="{{ review_text }}">
        <input type="hidden" name="overview_sentiment" value="{{ overview.sentiment }}">
        <input type="hidden" name="overview_score" value="{{ overview.score }}">
        <input type="hidden" name="total_words" value="{{ metrics.total_words }}">
        <input type="hidden" name="positive_words" value="{{ metrics.word_counts.positive }}">
        <input type="hidden" name="negative_words" value="{{ metrics.word_counts.negative }}">
        <input type="hidden" name="neutral_words" value="{{ metrics.word_counts.neutral }}">
        <input type="hidden" name="intensifiers" value="{{ metrics.word_counts.intensifiers }}">
        <input type="hidden" name="negations" value="{{ metrics.word_counts.negations }}">
        <input type="hidden" name="positive_percentage" value="{{ metrics.percentages.positive }}">
        <input type="hidden" name="negative_percentage" value="{{ metrics.percentages.negative }}">
        <input type="hidden" name="neutral_percentage" value="{{ metrics.percentages.neutral }}">
        <input type="hidden" name="positive_summary" value="{{ summary.positive|join:'|||' }}">
        <input type="hidden" name="negative_summary" value="{{ summary.negative|join:'|||' }}">
        <input type="hidden" name="neutral_summary" value="{{ summary.neutral|join:'|||' }}">
        
        <!-- JSON data containers - make sure these exist -->
        {{ word_analysis.positive_words|json_script:"positiveWordsData" }}
        {{ word_analysis.negative_words|json_script:"negativeWordsData" }}
        {{ word_analysis.intensifiers|json_script:"intensifiersData" }}
        {{ word_analysis.negations|json_script:"negationsData" }}

        <!-- Add fallback hidden elements in case the above are empty -->
        <script id="positiveWordsData" type="application/json">[]</script>
        <script id="negativeWordsData" type="application/json">[]</script>
        <script id="intensifiersData" type="application/json">[]</script>
        <script id="negationsData" type="application/json">[]</script>
        
        <button type="submit" class="btn secondary">üíæ Save Result</button>
    </form>
</div>

<style>
    /* Results Specific Styles */
    .results-header {
        margin-bottom: 2rem;
    }
    
    .results-header h1 {
        margin: 0 0 0.5rem 0;
        color: #1f2937;
    }
    
    .results-header p {
        color: #6b7280;
        margin: 0;
    }
    
    .product-info {
        padding: 1rem 0;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .sentiment-positive { color: #10b981; font-weight: 600; }
    .sentiment-negative { color: #ef4444; font-weight: 600; }
    .sentiment-neutral { color: #6b7280; font-weight: 600; }
    
    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }
    
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        text-align: center;
        border: 1px solid #e5e7eb;
    }
    
    .stat-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin: 0.5rem 0;
    }
    
    .stat-label {
        color: #6b7280;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }
    
    .stat-percentage {
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .positive .stat-number { color: #10b981; }
    .negative .stat-number { color: #ef4444; }
    .neutral .stat-number { color: #6b7280; }
    .modifiers .stat-number { color: #8b5cf6; }
    
    /* Summary Sections */
    .summary-section {
        margin: 1.5rem 0;
        padding: 1.5rem;
        border-radius: 8px;
        border-left: 4px solid;
    }
    
    .summary-section.positive {
        background: #f0fdf4;
        border-left-color: #10b981;
    }
    
    .summary-section.negative {
        background: #fef2f2;
        border-left-color: #ef4444;
    }
    
    .summary-section.neutral {
        background: #f9fafb;
        border-left-color: #6b7280;
    }
    
    .summary-title {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
    }
    
    .summary-item {
        margin: 0.5rem 0;
        line-height: 1.5;
    }
    
    .bullet {
        color: #6b7280;
        margin-right: 0.5rem;
    }
    
    /* Word Analysis */
    .word-analysis {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
    }
    
    .word-category {
        margin-bottom: 1.5rem;
    }
    
    .word-category h4 {
        margin: 0 0 1rem 0;
        font-size: 1rem;
        color: #374151;
    }
    
    .word-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .word-tag {
        display: inline-block;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: help;
    }
    
    .word-tag.positive {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }
    
    .word-tag.negative {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }
    
    .word-tag.intensifier {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }
    
    .word-tag.negation {
        background: #e5e7eb;
        color: #374151;
        border: 1px solid #d1d5db;
    }
    
    .no-words {
        color: #9ca3af;
        font-style: italic;
        margin: 0.5rem 0;
    }
    
    /* Review Content */
    .review-content {
        padding: 1rem 0;
        line-height: 1.6;
        color: #374151;
    }
    
    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin: 2rem 0;
        flex-wrap: wrap;
    }

    .btn.secondary {
    background: #6c757d;
    color: white;
    }

    .btn.secondary:hover {
        background: #5a6268;
    }

    .action-buttons form {
        display: inline;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('saveAnalysisForm');
    
    if (form) {
        try {
            // Get data from Django's json_script
            const positiveWords = JSON.parse(document.getElementById('positiveWordsData').textContent);
            const negativeWords = JSON.parse(document.getElementById('negativeWordsData').textContent);
            const neutralWords = JSON.parse(document.getElementById('neutralWordsData').textContent);
            const intensifiers = JSON.parse(document.getElementById('intensifiersData').textContent);
            const negations = JSON.parse(document.getElementById('negationsData').textContent);
            
            // Set form values
            document.getElementById('positiveWordsInput').value = JSON.stringify(positiveWords);
            document.getElementById('negativeWordsInput').value = JSON.stringify(negativeWords);
            document.getElementById('neutralWordsInput').value = JSON.stringify(neutralWords);
            document.getElementById('intensifiersInput').value = JSON.stringify(intensifiers);
            document.getElementById('negationsInput').value = JSON.stringify(negations);
            
            // Set form action dynamically
            form.action = "{% url 'save_analysis' %}";
            
            console.log('Form data prepared successfully');
        } catch (error) {
            console.error('Error preparing form data:', error);
        }
    }
});
</script>

{% endblock %}